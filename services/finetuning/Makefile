CONTAINER_BUILDER ?= docker

# copies boilerplate code to suitable locations
boilerplate:
	rm tsfmfinetuning/.gitignore || true
	echo "# THIS FILE IS AUTOMATICALLY GENERATED, YOUR CHANGES WILL BE OVERWRITTEN" > tsfmfinetuning/.gitignore
	for f in ../boilerplate/*.py; do \
		echo $$f; \
		cat ../boilerplate/warning.txt > tsfmfinetuning/$$(basename $$f); \
		cat $$f>>tsfmfinetuning/$$(basename $$f); \
		echo $$(basename $$f) >> tsfmfinetuning/.gitignore; \
		done 

image:
	$(CONTAINER_BUILDER) build -t tsfmfinetuning -f Dockerfile .

clone_models:
	git lfs install || true
	git clone https://huggingface.co/ibm-research/test-tsfm mytest-tsfm || true
	cd mytest-tsfm && git checkout fc98672d6d1f58305ce50038b63a6936c646f581 && cd .. || true


fetchdata:
	python tests/fetchdata.py

test_local: boilerplate fetchdata clone_models
	pytest -s tests

install_dev: boilerplate
	pip install poetry && poetry install --with dev
